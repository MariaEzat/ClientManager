<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #3a6ea5;
      font-size: 28px;
      margin-bottom: 25px;
      word-break: break-word;
    }

    label {
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
    }

    .hidden {
      display: none !important;
    }


    input,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      background-color: #3a6ea5;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
      margin: 5px 0;
      min-width: 100px;
    }

    button:hover {
      background-color: #2f5c88;
    }

    .btn-Delete {
      background-color: #d9534f;
    }

    .btnDelete {
      border: none;
      background: none;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      table-layout: fixed;
      /* Ù…Ù‡Ù… Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† responsive */
      word-wrap: break-word;
    }

    th,
    td {
      text-align: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    th {
      background-color: #3a6ea5;
      color: white;
    }

    .summary,
    .total,
    .message {
      text-align: center;
      margin-top: 15px;
      font-size: 16px;
    }

    .message {
      background-color: #eef5ff;
      border-radius: 10px;
      padding: 10px;
      color: #2f5c88;
      font-weight: bold;
      display: none;
    }

    .payment-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items: center;
    }

    .payment-row input {
      width: 150px;
      max-width: 100%;
      box-sizing: border-box;
    }

    .hidden {
      display: none;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø®ÙŠØ± (Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬) */
    th:last-child,
    td:last-child {
      width: 25px !important;
      /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ */
      padding: 0 !important;
      /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ */
    }

    td:last-child button {
      font-size: 12px !important;
      /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
      padding: 1px 2px !important;
      /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ */
      min-width: 0 !important;
      line-height: 1 !important;
    }


    /* ======= ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ======= */
    @media (max-width: 600px) {
      .container {
        padding: 10px;
        margin: 5px;
      }

      h1 {
        font-size: 22px;
      }

      table,
      th,
      td {
        font-size: 12px !important;
        /* padding: 4px !important; */
      }

      th:last-child,
      td:last-child {
        width: 25px !important;
      }

      input,
      select,
      button {
        font-size: 14px;
        padding: 8px;
      }

      .payment-row {
        flex-direction: column;
        gap: 8px;
      }

      .payment-row input {
        width: 50%;
      }

      .actions {
        flex-direction: column;
        gap: 10px;
      }



      th,
      td {
        min-width: auto;
        /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø§Ù„ÙˆØ§Ø³Ø¹ */

      }

      th:last-child,
      td:last-child {
        width: 30px;
        /* ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø­Ø°Ù */
        padding: 2px;
      }

      td:last-child button {
        font-size: 14px;
        /* ØªØµØºÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø¨Ø§Ù„Ø© */
        padding: 2px;
      }

      table {
        display: table;
        /* Ù…Ù†Ø¹ Ø§Ù„Ù€ scroll block */
        overflow-x: hidden;
        /* Ø¥Ø²Ø§Ù„Ø© scroll Ø£ÙÙ‚ÙŠ */
        table-layout: auto;
        /* Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨ */
      }
    }

    /* ØªØ­Ø³ÙŠÙ† Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµØºÙŠØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 400px) {
      button {
        font-size: 13px;
        padding: 6px 10px;
      }
    }
  </style>

</head>

<body>
  <div class="container">
    <h1>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>

    <!-- Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div id="clientSection">
      <!-- <button id="logoutBtn"
        style="float: right; background:#d9534f; color:white; padding:5px 10px; border:none; border-radius:5px; cursor:pointer;">
        ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
      </button> -->

      <label>Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„:</label>
      <select id="clientSelect">
        <option value="">-- Ø§Ø®ØªØ§Ø± Ø¹Ù…ÙŠÙ„ --</option>
      </select>
      <button id="addClientBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
      <button id="deleteClientBtn" class="btn-Delete">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</button>

      <table id="clientTable" class="hidden">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>

            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button id="addProductBtn" class="hidden">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„</button>

      <div class="summary hidden" id="summary">
        <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total">0</span> Ø¬Ù†ÙŠÙ‡</p>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span id="totalPaid">0</span> Ø¬Ù†ÙŠÙ‡</p>
        <p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remaining">0</span> Ø¬Ù†ÙŠÙ‡</p>

        <div class="payment-row">
          <input type="number" id="paid" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹">
          <button id="confirmPaymentBtn">ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…</button>
        </div>

        <div class="message" id="paymentMessage"></div>
        <button id="showReportBtn">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ -->
    <div id="addClientSection" class="hidden">
      <h1>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h1>
      <label id="clientNameLabel">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
      <input type="text" id="clientNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‡Ù†Ø§">


      <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
      <input type="number" id="clientCodeInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />


      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
      <input type="text" id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
      <input type="number" id="productQty" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹">
      <label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
      <input type="number" id="productPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡">
      <button id="addProductNewClientBtn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>

      <table id="productsTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>

          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="totalPrice">0</span> Ø¬Ù†ÙŠÙ‡</div>
      <div class="actions">
        <button id="saveClientBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        <button id="backToClientSectionBtn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <div id="reportSection" class="hidden">
      <h1 id="reportClientName">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h1>
      <button id="downloadPdfBtn">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PDF</button>

      <table id="reportProductsTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>

          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="total">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="reportTotal">0</span> Ø¬Ù†ÙŠÙ‡<br>
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span id="reportPaid">0</span> Ø¬Ù†ÙŠÙ‡<br>
        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="reportRemain">0</span> Ø¬Ù†ÙŠÙ‡
      </div>

      <h3 style="margin-top:20px;">ğŸ’³ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</h3>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="backFromReportBtn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
    </div>
    <div id="editPaymentPopup" class="hidden" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
">
      <div style="
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 300px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  ">
        <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº</h3>
        <input type="number" id="editPaymentInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯"
          style="width: 100%; padding: 8px; margin: 10px 0; font-size: 16px;">
        <div style="display: flex; justify-content: space-between;">
          <button id="savePaymentBtn"
            style="background:#3a6ea5;color:white;padding:8px 15px;border:none;border-radius:5px;cursor:pointer;">Ø­ÙØ¸</button>
          <button id="cancelPaymentBtn"
            style="background:#d9534f;color:white;padding:8px 15px;border:none;border-radius:5px;cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyD3Fg6CKVhe4cdDa-zJHOAaTTRQVp6YRv4",
        authDomain: "client-manager-51c15.firebaseapp.com",
        databaseURL: "https://client-manager-51c15-default-rtdb.firebaseio.com",
        projectId: "client-manager-51c15",
        storageBucket: "client-manager-51c15.appspot.com",
        messagingSenderId: "48173898256",
        appId: "1:48173898256:web:b8bb7e9efb772fc79e4895"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth(); // Ø³ÙŠÙƒÙˆÙ† Ø´ØºØ§Ù„ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø£

      // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
      auth.onAuthStateChanged(user => {
        if (!user) {
          window.location.replace("login.html");
        } else {
          // Ù‡Ù†Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„ÙŠÙ‹Ø§
          // Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙƒÙ€ fallback
          const localClients = loadClientsFromLocalStorage();
          if (localClients && localClients.length) {
            clients = localClients;
          }


          fetchClientsOnline();
          showClientSection();
        }
      });

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
      // document.getElementById("logoutBtn").addEventListener("click", () => {
      //   auth.signOut().then(() => window.location.href = "login.html");
      // });
      let clients = [];
      let newClientProducts = [];

      // Ø¹Ù†Ø§ØµØ± DOM
      const clientSection = document.getElementById("clientSection");
      const addClientSection = document.getElementById("addClientSection");
      const reportSection = document.getElementById("reportSection");
      const clientSelect = document.getElementById("clientSelect");
      const addClientBtn = document.getElementById("addClientBtn");
      const deleteClientBtn = document.getElementById("deleteClientBtn");
      const addProductBtn = document.getElementById("addProductBtn");
      const confirmPaymentBtn = document.getElementById("confirmPaymentBtn");
      const showReportBtn = document.getElementById("showReportBtn");
      const saveClientBtn = document.getElementById("saveClientBtn");
      const backToClientSectionBtn = document.getElementById("backToClientSectionBtn");
      const addProductNewClientBtn = document.getElementById("addProductNewClientBtn");
      const backFromReportBtn = document.getElementById("backFromReportBtn");
      const editPaymentPopup = document.getElementById("editPaymentPopup");
      const editPaymentInput = document.getElementById("editPaymentInput");
      const savePaymentBtn = document.getElementById("savePaymentBtn");
      const cancelPaymentBtn = document.getElementById("cancelPaymentBtn");

      let currentEditIndex = null; // Ø£ÙŠ Ø¯ÙØ¹Ø© Ù†Ø¹Ø¯Ù„

      // ==== Ø¯ÙˆØ§Ù„ Firebase ====
      function fetchClientsOnline() {
        db.ref('clients/' + auth.currentUser.uid).once('value').then(snapshot => {
          clients = snapshot.exists() ? snapshot.val() : [];
          loadClients();
        });
      }

      function saveClientsOnline() {
        db.ref('clients/' + auth.currentUser.uid).set(clients)
          .then(() => console.log("âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"));
      }


      // ==== Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ====
      function showClientSection() {
        clientSection.classList.remove("hidden");
        addClientSection.classList.add("hidden");
        reportSection.classList.add("hidden");
        document.getElementById("clientTable").classList.add("hidden");
        document.getElementById("summary").classList.add("hidden");
        addProductBtn.classList.add("hidden");
        loadClients();
        const savedClient = localStorage.getItem("selectedClientNumber");
        if (savedClient) {
          const index = clients.findIndex(c => c.code == savedClient);
          if (index !== -1) {
            clientSelect.value = index;
            showClientDetails(); // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯
          }
          localStorage.removeItem("selectedClientNumber");
        }
      }

      function showAddClient() {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰
        clientSection.classList.add("hidden");
        reportSection.classList.add("hidden");
        addClientSection.classList.remove("hidden");

        // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("clientNameInput").value = "";
        document.getElementById("clientCodeInput").value = "";
        document.getElementById("clientCodeInput").readOnly = false;
        document.getElementById("productName").value = "";
        document.getElementById("productQty").value = "";
        document.getElementById("productPrice").value = "";

        // Ù…Ø³Ø­ Ø¬Ø¯ÙˆÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const productsTbody = document.querySelector("#productsTable tbody");
        productsTbody.innerHTML = "";

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        document.getElementById("totalPrice").textContent = "0";

        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        newClientProducts = [];

        // Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
        document.getElementById("clientTable").classList.add("hidden");
        document.getElementById("summary").classList.add("hidden");
        addProductBtn.classList.add("hidden");
      }


      // ======== Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ ========
      function addProduct() {
        const index = clientSelect.value;
        if (index === "") return alert("â— Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        const client = clients[index];

        // Ù†Ø³Ø® Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        newClientProducts = [...client.products.map(p => ({ ...p }))];

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ readonly
        document.getElementById("clientNameInput").value = client.name;
        document.getElementById("clientCodeInput").value = client.code;
        document.getElementById("clientCodeInput").readOnly = true;

        // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        clientSection.classList.add("hidden");
        addClientSection.classList.remove("hidden");

        renderNewClientTable();
      }

      // ==== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ====
      // ================== Ø§Ø³ØªØ¨Ø¯Ø§Ù„: loadClients ==================
      function loadClients() {
        // clients Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† array Ø£Ùˆ object Ù…Ù† Firebase â€” Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¯Ù†Ø§Ù‡ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ array
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ (ÙŠØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ Ø±Ù‚Ù…ÙŠ)
        clients = clients.map(c => {
          // Ù„Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø®Ø²Ù‘Ù† ÙƒØ³Ù„Ø³Ù„Ø© Ø­ÙˆÙ„Ù‡ Ù„Ø±Ù‚Ù… Ù„Ùˆ Ù…Ù…ÙƒÙ†
          if (c && typeof c.code === "string" && c.code.trim() !== "") {
            const n = Number(c.code);
            if (!isNaN(n)) c.code = n;
          }
          return c;
        });

        clients.sort((a, b) => {
          const ca = (a && a.code) ? Number(a.code) : Infinity;
          const cb = (b && b.code) ? Number(b.code) : Infinity;
          return ca - cb;
        });

        clientSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ§Ø± Ø¹Ù…ÙŠÙ„ --</option>';
        clients.forEach((c, i) => {
          const opt = document.createElement("option");
          opt.value = i;
          // Ø¹Ø±Ø¶ (Ø§Ù„ÙƒÙˆØ¯) Ø§Ù„Ø§Ø³Ù… â€” Ø¥Ø°Ø§ Ù…ÙÙŠØ´ ÙƒÙˆØ¯ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
          opt.textContent = (c && c.code) ? `(${c.code}) ${c.name}` : `${c.name}`;
          clientSelect.appendChild(opt);
        });
      }


      function showClientDetails() {
        const index = clientSelect.value;
        if (index === "") return;
        const client = clients[index];
        const tbody = document.querySelector("#clientTable tbody");
        tbody.innerHTML = "";
        client.products.forEach((p, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
    <td>${p.name}</td>
    <td>${p.qty}</td>
    <td>${p.price}</td>
    <td>${p.total}</td>
    <td>${p.dateAdded || '-'}</td> <!-- Ù‡Ù†Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
    <td><button class="btnDelete">ğŸ—‘ï¸</button></td>
  `;
          tr.querySelector("button").addEventListener("click", () => deleteProduct(index, i));
          tbody.appendChild(tr);
        });

        document.getElementById("clientTable").classList.remove("hidden");
        document.getElementById("summary").classList.remove("hidden");
        addProductBtn.classList.remove("hidden");

        const total = client.products.reduce((sum, p) => sum + p.total, 0);
        const paid = client.paid || 0;
        const remaining = total - paid;

        document.getElementById("total").textContent = total;
        document.getElementById("totalPaid").textContent = paid;
        document.getElementById("remaining").textContent = remaining;
        document.getElementById("paid").value = "";
        document.getElementById("paymentMessage").style.display = "none";
      }

      // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙØ©ØŒ Ø­Ø°ÙØŒ Ø§Ù„Ø¯ÙØ¹ØŒ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
      function addProductToNewClient() {
        const name = document.getElementById("productName").value.trim();
        const qty = Number(document.getElementById("productQty").value);
        const price = Number(document.getElementById("productPrice").value);
        if (!name || qty <= 0 || price <= 0) return alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");

        const product = {
          name,
          qty,
          price,
          total: qty * price,
          dateAdded: new Date().toISOString().split("T")[0].split("-").reverse().join("/")
        };

        newClientProducts.push(product);

        const index = clientSelect.value;
        const isExistingClient = index !== "";

        if (isExistingClient) {
          const client = clients[index];
          client.products.push(product);
          client.total = client.products.reduce((sum, p) => sum + p.total, 0);
          saveClientsOnline();
          showClientDetails();
        }

        renderNewClientTable();

        document.getElementById("productName").value = "";
        document.getElementById("productQty").value = "";
        document.getElementById("productPrice").value = "";
      }

      function renderNewClientTable() {
        const tbody = document.querySelector("#productsTable tbody");
        tbody.innerHTML = "";
        let totalPrice = 0;
        newClientProducts.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${p.name}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.total}</td>`;
          tbody.appendChild(tr);
          totalPrice += p.total;
        });
        document.getElementById("totalPrice").textContent = totalPrice;
      }


      // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© â€” Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      function saveClient() {
        const name = document.getElementById("clientNameInput").value.trim();
        const codeStr = document.getElementById("clientCodeInput").value.trim();

        if (!codeStr) return alert("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)");
        if (!/^\d+$/.test(codeStr)) return alert("Ø§Ù„ÙƒÙˆØ¯ Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·");
        const code = Number(codeStr);

        if (!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
        if (newClientProducts.length === 0) return alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

        // Ù‡Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ØŸ
        const existingIndex = clients.findIndex(c => Number(c.code) === code);

        const isEditingExistingClient = document.getElementById("clientCodeInput").readOnly;
        // Ù„Ùˆ readOnly ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„ (ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ Ù…Ù† select)

        if (existingIndex !== -1 && !isEditingExistingClient) {
          // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
          const confirmUpdate = confirm("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ");
          if (!confirmUpdate) return;
        }

        let client;
        if (existingIndex !== -1) {
          // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
          client = clients[existingIndex];
          client.name = name;
          client.products = [...newClientProducts];
          client.total = newClientProducts.reduce((sum, p) => sum + p.total, 0);
          if (client.paid === undefined) client.paid = 0;
          if (!Array.isArray(client.history)) client.history = [];
          saveClientsOnline();
          saveClientsLocal();
          alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");
        } else {
          // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
          client = {
            code: code,
            name: name,
            products: newClientProducts.map(p => ({ ...p })),
            total: newClientProducts.reduce((sum, p) => sum + p.total, 0),
            paid: 0,
            history: []
          };
          clients.push(client);
          saveClientsOnline();
          saveClientsLocal();
          alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„");
        }
        localStorage.setItem("selectedClientNumber", client.code);

        showClientSection();
      }

      function deleteClient() {
        const index = clientSelect.value;
        if (index === "") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
        if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${clients[index].name}?`)) {
          clients.splice(index, 1);
          saveClientsOnline();
          saveClientsLocal();
          showClientSection();
        }
      }

      function deleteProduct(clientIndex, productIndex) {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
          clients[clientIndex].products.splice(productIndex, 1);
          clients[clientIndex].total = clients[clientIndex].products.reduce((sum, p) => sum + p.total, 0);
          saveClientsOnline();
          showClientDetails();
        }
      }


      function confirmPayment() {
        const index = clientSelect.value;
        if (index === "") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
        const client = clients[index];

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
        if (client.paid === undefined) client.paid = 0;
        if (!Array.isArray(client.history)) client.history = [];

        const newPayment = Number(document.getElementById("paid").value);
        if (isNaN(newPayment) || newPayment <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

        client.paid += newPayment;
        client.history.push({ date: formatDateTime(), paid: newPayment });
        saveClientsOnline();

        const remaining = client.total - client.paid;
        document.getElementById("totalPaid").textContent = client.paid;
        document.getElementById("remaining").textContent = remaining;

        const msg = document.getElementById("paymentMessage");
        msg.style.display = "block";
        msg.textContent = remaining === 0 ? `âœ… ØªÙ… Ø¯ÙØ¹ ${newPayment}` : `ğŸ’° ØªÙ… Ø¯ÙØ¹ ${newPayment} â€” Ø§Ù„Ø¨Ø§Ù‚ÙŠ ${remaining}`;
        document.getElementById("paid").value = "";

        showClientDetails();
      }
      function formatDateTime() {
        const d = new Date();
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();

        let hours = d.getHours();
        const minutes = String(d.getMinutes()).padStart(2, '0');

        // ØªØ­Ø¯ÙŠØ¯ AM/PM
        const ampm = hours >= 12 ? 'PM' : 'AM';

        // ØªØ­ÙˆÙŠÙ„ Ù„Ù€ 12 Ø³Ø§Ø¹Ø©
        hours = hours % 12;
        hours = hours ? hours : 12; // 12 Ø¨Ø¯Ù„ 0
        hours = String(hours).padStart(2, '0');

        return `${day}/${month}/${year} , ${hours}:${minutes} ${ampm}`;
      }


      function showReport() {
        const index = clientSelect.value;
        if (index === "") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
        clientSection.classList.add("hidden");
        addClientSection.classList.add("hidden");
        reportSection.classList.remove("hidden");
        const client = clients[index];
        document.getElementById("reportClientName").textContent = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client.name}`;

        const tbody = document.querySelector("#reportProductsTable tbody");
        tbody.innerHTML = "";
        client.products.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
    <td>${p.name}</td>
    <td>${p.qty}</td>
    <td>${p.price}</td>
    <td>${p.total}</td>
    <td>${p.dateAdded || '-'}</td>
  `;
          tbody.appendChild(tr);
        });

        document.getElementById("reportTotal").textContent = client.total;
        document.getElementById("reportPaid").textContent = client.paid;
        document.getElementById("reportRemain").textContent = client.total - client.paid;

        const histBody = document.querySelector("#historyTable tbody");
        histBody.innerHTML = "";
        client.history.forEach((h, i) => {
          const tr = document.createElement("tr");
          const tdDate = document.createElement("td");
          tdDate.textContent = h.date;

          const tdPaid = document.createElement("td");
          tdPaid.textContent = h.paid;
          tdPaid.style.cursor = "pointer";
          tdPaid.addEventListener("click", () => {
            currentEditIndex = i;
            editPaymentInput.value = h.paid;
            editPaymentPopup.classList.remove("hidden");
          });

          tr.appendChild(tdDate);
          tr.appendChild(tdPaid);
          histBody.appendChild(tr);
        });
      }

      // ==== Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ====
      addClientBtn.addEventListener("click", showAddClient);
      deleteClientBtn.addEventListener("click", deleteClient);
      addProductBtn.addEventListener("click", addProduct);
      confirmPaymentBtn.addEventListener("click", confirmPayment);
      showReportBtn.addEventListener("click", showReport);
      saveClientBtn.addEventListener("click", saveClient);
      backToClientSectionBtn.addEventListener("click", showClientSection);
      addProductNewClientBtn.addEventListener("click", addProductToNewClient);
      backFromReportBtn.addEventListener("click", showClientSection);
      clientSelect.addEventListener("change", showClientDetails);


      document.getElementById("downloadPdfBtn").addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById("reportSection");

        const downloadBtn = document.getElementById("downloadPdfBtn");
        const backBtn = document.getElementById("backFromReportBtn");
        downloadBtn.style.display = "none";
        backBtn.style.display = "none";

        const table = document.getElementById("reportProductsTable");
        const oldDisplay = table.style.display;
        const oldOverflow = table.style.overflowX;

        // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ block ÙƒØ§Ù…Ù„ Ù„ÙŠØ¸Ù‡Ø± ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        table.style.display = "table";
        table.style.overflowX = "visible";

        const clientName = document.getElementById("reportClientName").textContent.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, "_");

        html2canvas(element, { scale: 3, useCORS: true }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'mm', 'a4');
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          const imgProps = pdf.getImageProperties(imgData);
          const imgWidth = pageWidth - 20; // 10mm margin
          const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

          let heightLeft = imgHeight;
          let position = 10;

          pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight - 20;

          while (heightLeft > 0) {
            position = heightLeft - imgHeight + 10;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight - 20;
          }

          pdf.save(`${clientName}.pdf`);

          // Ø±Ø¬Ø¹ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
          downloadBtn.style.display = "inline-block";
          backBtn.style.display = "inline-block";
          table.style.display = oldDisplay;
          table.style.overflowX = oldOverflow;
        });
      });


      // Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù…ØªØºÙŠÙ‘Ø± `clients` ÙÙŠ localStorage
      function saveClientsLocal() {
        try {
          localStorage.setItem("clients", JSON.stringify(clients));
        } catch (e) {
          console.error("Error saving clients to localStorage:", e);
        }
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† localStorage (ÙŠØ±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© Ø£Ùˆ [])
      function loadClientsFromLocalStorage() {
        try {
          return JSON.parse(localStorage.getItem("clients")) || [];
        } catch (e) {
          console.error("Error reading clients from localStorage:", e);
          return [];
        }
      }
      savePaymentBtn.addEventListener("click", () => {
        const newPaid = Number(editPaymentInput.value);
        if (isNaN(newPaid) || newPaid < 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

        const index = clientSelect.value;
        const client = clients[index];

        if (newPaid === 0) {
          // Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          client.history.splice(currentEditIndex, 1);
        } else {
          // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©
          client.history[currentEditIndex].paid = newPaid;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹
        client.paid = client.history.reduce((sum, p) => sum + p.paid, 0);

        saveClientsOnline();
        saveClientsLocal();
        showReport();
        editPaymentPopup.classList.add("hidden");

      });


      cancelPaymentBtn.addEventListener("click", () => {
        editPaymentPopup.classList.add("hidden");
      });


    </script>


</body>

</html>