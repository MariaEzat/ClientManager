<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
<style>
body { font-family: 'Cairo', sans-serif; background-color: #f5f7fa; margin:0; padding:0; }
.container { max-width:900px; margin:30px auto; background:white; padding:30px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
h1 { text-align:center; color:#3a6ea5; font-size:28px; margin-bottom:30px; }
label { font-weight:bold; margin-bottom:8px; display:block; }
input, select { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; margin-bottom:10px; }
button { background-color:#3a6ea5; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:16px; transition:.3s; margin:5px 0; }
button:hover { background-color:#2f5c88; }
.btn-Delete { background-color:#d9534f; }
.btnDelete { border:none; background:none; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { text-align:center; padding:10px; border-bottom:1px solid #eee; font-size:15px; }
th { background-color:#3a6ea5; color:white; }
.summary, .total, .message { text-align:center; margin-top:15px; font-size:16px; }
.message { background-color:#eef5ff; border-radius:10px; padding:10px; color:#2f5c88; font-weight:bold; display:none; }
.payment-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; align-items:center; }
.payment-row input { width:150px; }
.hidden { display:none; }
.actions { display:flex; justify-content:space-between; margin-top:20px; }
@media (max-width:600px) { .payment-row { flex-direction:column; } input { width:93%; } .actions { flex-direction:column; gap:10px; } .actions button:first-child { align-self:flex-end; } .actions button:last-child { align-self:flex-start; } }
</style>
</head>
<body>
<div class="container">
<h1>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>

<div id="clientSection">
<label>Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„:</label>
<select id="clientSelect">
  <option value="">-- Ø§Ø®ØªØ§Ø± Ø¹Ù…ÙŠÙ„ --</option>
</select>
<button id="addClientBtn">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
<button id="deleteClientBtn" class="btn-Delete">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</button>

<table id="clientTable" class="hidden">
  <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø­Ø°Ù</th></tr></thead>
  <tbody></tbody>
</table>

<button id="addProductBtn" class="hidden">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„</button>

<div class="summary hidden" id="summary">
<p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total">0</span> Ø¬Ù†ÙŠÙ‡</p>
<p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span id="totalPaid">0</span> Ø¬Ù†ÙŠÙ‡</p>
<p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remaining">0</span> Ø¬Ù†ÙŠÙ‡</p>

<div class="payment-row">
<input type="number" id="paid" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹">
<button id="confirmPaymentBtn">ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…</button>
</div>

<div class="message" id="paymentMessage"></div>
<button id="showReportBtn">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
</div>
</div>

<div id="addClientSection" class="hidden">
<h1>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h1>
<label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
<input type="text" id="newClientName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
<label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
<input type="text" id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
<input type="number" id="productQty" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹">
<label>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
<input type="number" id="productPrice" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡">
<button id="addProductNewClientBtn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>

<table id="productsTable">
<thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
<tbody></tbody>
</table>

<div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="totalPrice">0</span> Ø¬Ù†ÙŠÙ‡</div>
<div class="actions">
<button id="saveClientBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
<button id="backToClientSectionBtn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>
</div>

<div id="reportSection" class="hidden">
<h1 id="reportClientName">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h1>
<table id="reportProductsTable">
<thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
<tbody></tbody>
</table>

<div class="total">
Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: <span id="reportTotal">0</span> Ø¬Ù†ÙŠÙ‡<br>
Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span id="reportPaid">0</span> Ø¬Ù†ÙŠÙ‡<br>
Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="reportRemain">0</span> Ø¬Ù†ÙŠÙ‡
</div>

<h3 style="margin-top:20px;">ğŸ’³ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</h3>
<table id="historyTable">
<thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th></tr></thead>
<tbody></tbody>
</table>
<button id="backFromReportBtn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD3Fg6CKVhe4cdDa-zJHOAaTTRQVp6YRv4",
  authDomain: "client-manager-51c15.firebaseapp.com",
  databaseURL: "https://client-manager-51c15-default-rtdb.firebaseio.com",
  projectId: "client-manager-51c15",
  storageBucket: "client-manager-51c15.appspot.com",
  messagingSenderId: "48173898256",
  appId: "1:48173898256:web:b8bb7e9efb772fc79e4895"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let clients = [];
let newClientProducts = [];

const clientSection = document.getElementById("clientSection");
const addClientSection = document.getElementById("addClientSection");
const reportSection = document.getElementById("reportSection");

const clientSelect = document.getElementById("clientSelect");
const addClientBtn = document.getElementById("addClientBtn");
const deleteClientBtn = document.getElementById("deleteClientBtn");
const addProductBtn = document.getElementById("addProductBtn");
const confirmPaymentBtn = document.getElementById("confirmPaymentBtn");
const showReportBtn = document.getElementById("showReportBtn");
const saveClientBtn = document.getElementById("saveClientBtn");
const backToClientSectionBtn = document.getElementById("backToClientSectionBtn");
const addProductNewClientBtn = document.getElementById("addProductNewClientBtn");
const backFromReportBtn = document.getElementById("backFromReportBtn");

// Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† Firebase
function fetchClientsOnline() {
  db.ref('clients/').once('value').then(snapshot => {
    if(snapshot.exists()) clients = snapshot.val();
    else clients = [];
    loadClients();
  });
}

// Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù„Ù‰ Firebase
function saveClientsOnline(){
  db.ref('clients/').set(clients).then(()=>console.log("âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"));
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
function showClientSection(){
  clientSection.classList.remove("hidden");
  addClientSection.classList.add("hidden");
  reportSection.classList.add("hidden");
  loadClients();
  document.getElementById("clientTable").classList.add("hidden");
  document.getElementById("summary").classList.add("hidden");
  addProductBtn.classList.add("hidden");
}

function showAddClient(){
  clientSection.classList.add("hidden");
  addClientSection.classList.remove("hidden");
  reportSection.classList.add("hidden");
  document.getElementById("newClientName").value="";
  document.getElementById("productName").value="";
  document.getElementById("productQty").value="";
  document.getElementById("productPrice").value="";
  newClientProducts=[];
  renderNewClientTable();
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (loadClients, showClientDetails, addProductToNewClient, renderNewClientTable, saveClient, deleteClient, deleteProduct, addProduct, confirmPayment, showReport)
// ... Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¯ÙˆØ§Ù„Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ localStorage Ø¨Ø§Ù„Ù€ Firebase
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª
function loadClients(){
  clientSelect.innerHTML='<option value="">-- Ø§Ø®ØªØ§Ø± Ø¹Ù…ÙŠÙ„ --</option>';
  clients.forEach((c,i)=>{
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=c.name;
    clientSelect.appendChild(opt);
  });
}

function showClientDetails(){
  const index = clientSelect.value;
  if(index==="") return;
  const client = clients[index];
  const tbody = document.querySelector("#clientTable tbody");
  tbody.innerHTML="";
  client.products.forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.name}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.total}</td>
      <td><button class="btnDelete">ğŸ—‘ï¸</button></td>`;
    tr.querySelector("button").addEventListener("click", ()=>deleteProduct(index,i));
    tbody.appendChild(tr);
  });
  document.getElementById("clientTable").classList.remove("hidden");
  document.getElementById("summary").classList.remove("hidden");
  addProductBtn.classList.remove("hidden");

  const total = client.products.reduce((sum,p)=>sum+p.total,0);
  const paid = client.paid||0;
  const remaining = total-paid;

  document.getElementById("total").textContent=total;
  document.getElementById("totalPaid").textContent=paid;
  document.getElementById("remaining").textContent=remaining;
  document.getElementById("paid").value="";
  document.getElementById("paymentMessage").style.display="none";

  client.total=total;
  localStorage.setItem("clients", JSON.stringify(clients));
}

function addProductToNewClient(){
  const name=document.getElementById("productName").value.trim();
  const qty=Number(document.getElementById("productQty").value);
  const price=Number(document.getElementById("productPrice").value);
  if(!name||qty<=0||price<=0) return alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");
  const product={name,qty,price,total:qty*price};
  newClientProducts.push(product);
  renderNewClientTable();
  document.getElementById("productName").value="";
  document.getElementById("productQty").value="";
  document.getElementById("productPrice").value="";
}

function renderNewClientTable(){
  const tbody=document.querySelector("#productsTable tbody");
  tbody.innerHTML="";
  let totalPrice=0;
  newClientProducts.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.name}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.total}</td>`;
    tbody.appendChild(tr);
    totalPrice+=p.total;
  });
  document.getElementById("totalPrice").textContent=totalPrice;
}

function saveClient(){
  const name=document.getElementById("newClientName").value.trim();
  if(!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
  if(newClientProducts.length===0) return alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
  const total=newClientProducts.reduce((sum,p)=>sum+p.total,0);
  const client={name,products:newClientProducts,total,paid:0,history:[]};
  clients.push(client);
  localStorage.setItem("clients", JSON.stringify(clients));
  saveClientsOnline();
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„");
  showClientSection();
}

function deleteClient(){
  const index=clientSelect.value;
  if(index==="") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
  if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${clients[index].name}?`)){
    clients.splice(index,1);
    localStorage.setItem("clients", JSON.stringify(clients));
    saveClientsOnline();
    loadClients();
    document.getElementById("clientTable").classList.add("hidden");
    document.getElementById("summary").classList.add("hidden");
    addProductBtn.classList.add("hidden");
  }
}

function deleteProduct(clientIndex,productIndex){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")){
    clients[clientIndex].products.splice(productIndex,1);
    clients[clientIndex].total=clients[clientIndex].products.reduce((sum,p)=>sum+p.total,0);
    localStorage.setItem("clients", JSON.stringify(clients));
    saveClientsOnline();
    showClientDetails();
  }
}

function addProduct(){
  const index=clientSelect.value;
  if(index==="") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
  newClientProducts=[...clients[index].products.map(p=>({...p}))];
  document.getElementById("newClientName").value=clients[index].name;
  showAddClient();
  document.getElementById("saveClientBtn").onclick=()=>{
    if(newClientProducts.length===0) return alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
    clients[index].products=newClientProducts;
    clients[index].total=newClientProducts.reduce((sum,p)=>sum+p.total,0);
    localStorage.setItem("clients", JSON.stringify(clients));
    saveClientsOnline();
    alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");
    showClientSection();
  }
}

function confirmPayment(){
  const index=clientSelect.value;
  if(index==="") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
  const client=clients[index];
  const newPayment=Number(document.getElementById("paid").value);
  if(isNaN(newPayment)||newPayment<=0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
  client.paid=(client.paid||0)+newPayment;
  const remaining=client.total-client.paid;
  const now=new Date();
  client.history=client.history||[];
  client.history.push({date:now.toLocaleString(),paid:newPayment});
  localStorage.setItem("clients", JSON.stringify(clients));
  saveClientsOnline();

  document.getElementById("totalPaid").textContent=client.paid;
  document.getElementById("remaining").textContent=remaining;
  const msg=document.getElementById("paymentMessage");
  msg.style.display="block";
  msg.textContent=remaining===0?`âœ… ØªÙ… Ø¯ÙØ¹ ${newPayment}`:`ğŸ’° ØªÙ… Ø¯ÙØ¹ ${newPayment} â€” Ø§Ù„Ø¨Ø§Ù‚ÙŠ ${remaining}`;
  document.getElementById("paid").value="";
  showClientDetails();
}

function showReport(){
  const index=clientSelect.value;
  if(index==="") return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„");
  clientSection.classList.add("hidden");
  addClientSection.classList.add("hidden");
  reportSection.classList.remove("hidden");
  const client=clients[index];
  document.getElementById("reportClientName").textContent=`ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client.name}`;

  const tbody=document.querySelector("#reportProductsTable tbody");
  tbody.innerHTML="";
  client.products.forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.name}</td><td>${p.qty}</td><td>${p.price}</td><td>${p.total}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById("reportTotal").textContent=client.total;
  document.getElementById("reportPaid").textContent=client.paid;
  document.getElementById("reportRemain").textContent=client.total-client.paid;

  const histBody=document.querySelector("#historyTable tbody");
  histBody.innerHTML="";
  client.history.forEach(h=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${h.date}</td><td>${h.paid}</td>`;
    histBody.appendChild(tr);
  });
}

// Ù…Ø«Ø§Ù„: Ø­ÙØ¸ Ø¹Ù…ÙŠÙ„
function saveClient(){
  const name=document.getElementById("newClientName").value.trim();
  if(!name) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
  if(newClientProducts.length===0) return alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
  const total=newClientProducts.reduce((sum,p)=>sum+p.total,0);
  const client={name,products:newClientProducts,total,paid:0,history:[]};
  clients.push(client);
  saveClientsOnline();
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„");
  showClientSection();
}

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
addClientBtn.addEventListener("click", showAddClient);
deleteClientBtn.addEventListener("click", deleteClient);
addProductBtn.addEventListener("click", addProduct);
confirmPaymentBtn.addEventListener("click", confirmPayment);
showReportBtn.addEventListener("click", showReport);
saveClientBtn.addEventListener("click", saveClient);
backToClientSectionBtn.addEventListener("click", showClientSection);
addProductNewClientBtn.addEventListener("click", addProductToNewClient);
backFromReportBtn.addEventListener("click", showClientSection);
clientSelect.addEventListener("change", showClientDetails);

// Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
fetchClientsOnline();
showClientSection();
</script>
</body>
</html>
